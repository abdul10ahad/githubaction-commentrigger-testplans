name: Selective Tests with Tuist (Modular)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  checks: write
  contents: read
  statuses: write

jobs:
  selective-tests:
    runs-on: macos-latest
    timeout-minutes: 20

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Tuist
        run: |
          brew install tuist

      - name: Install Mint
        run: |
          brew install mint

      - name: Install XcodeSelectiveTesting
        run: |
          mint install mikeger/XcodeSelectiveTesting@0.13.1

      - name: Generate Xcode project with Tuist
        run: |
          tuist generate

      - name: Run Selective Tests
        id: selective-tests
        run: |
          echo "Running selective tests with XcodeSelectiveTesting..."
          mint run mikeger/XcodeSelectiveTesting@0.13.1 manual_Trigger.xcworkspace \
            --test-plan manual_Trigger/AllUnitTests.xctestplan \
            --test-plan manual_Trigger/FirstLegTests.xctestplan \
            --test-plan manual_Trigger/SecondLegTests.xctestplan \
            --test-plan manual_Trigger/ThirdLegTests.xctestplan \
            --base-branch origin/main
        continue-on-error: true

      - name: Run Tests
        id: run-tests
        run: |
          echo "Executing tests..."
          xcodebuild test \
            -workspace manual_Trigger.xcworkspace \
            -scheme manual_Trigger \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
        continue-on-error: true

      - name: Check test results
        run: |
          echo "=========================================="
          echo "Selective Test Results"
          echo "=========================================="
          echo ""
          echo "XcodeSelectiveTesting: ${{ steps.selective-tests.outcome }}"
          echo "Test Execution: ${{ steps.run-tests.outcome }}"
          echo ""
          echo "=========================================="

          if [ "${{ steps.run-tests.outcome }}" == "failure" ]; then
            echo ""
            echo "‚ùå Tests failed!"
            echo ""
            echo "üí° Check the logs above for detailed error messages"
            echo "üí° XcodeSelectiveTesting modified test plans to run only affected tests"
            echo ""
            exit 1
          else
            echo ""
            echo "‚úÖ All affected tests passed!"
            echo "üí° XcodeSelectiveTesting ran only tests affected by your changes"
            echo ""
          fi
