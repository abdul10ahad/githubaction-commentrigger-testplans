name: Selective Tests with Tuist (Modular)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  checks: write
  contents: read
  statuses: write

jobs:
  selective-tests:
    runs-on: macos-latest
    timeout-minutes: 20

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Tuist
        run: |
          curl -Ls https://install.tuist.io | bash

      - name: Generate Xcode project with Tuist
        run: |
          tuist generate

      - name: Run Unit Tests (FirstLegTests)
        id: first-leg
        run: |
          echo "Running FirstLegTests (Unit Tests)..."
          xcodebuild test \
            -workspace manual_Trigger.xcworkspace \
            -scheme manual_Trigger \
            -testPlan FirstLegTests \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
        continue-on-error: true

      - name: Run Unit Tests (SecondLegTests)
        id: second-leg
        run: |
          echo "Running SecondLegTests (Unit Tests)..."
          xcodebuild test \
            -workspace manual_Trigger.xcworkspace \
            -scheme manual_Trigger \
            -testPlan SecondLegTests \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
        continue-on-error: true

      - name: Run Unit Tests (ThirdLegTests)
        id: third-leg
        run: |
          echo "Running ThirdLegTests (Unit Tests)..."
          xcodebuild test \
            -workspace manual_Trigger.xcworkspace \
            -scheme manual_Trigger \
            -testPlan ThirdLegTests \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
        continue-on-error: true

      - name: Run UI Tests (MathFeature)
        id: math-ui-tests
        run: |
          echo "Running MathFeatureUITests..."
          xcodebuild test \
            -workspace manual_Trigger.xcworkspace \
            -scheme manual_Trigger \
            -only-testing:MathFeatureUITests \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
        continue-on-error: true

      - name: Run UI Tests (StringFeature)
        id: string-ui-tests
        run: |
          echo "Running StringFeatureUITests..."
          xcodebuild test \
            -workspace manual_Trigger.xcworkspace \
            -scheme manual_Trigger \
            -only-testing:StringFeatureUITests \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
        continue-on-error: true

      - name: Run UI Tests (ArrayFeature)
        id: array-ui-tests
        run: |
          echo "Running ArrayFeatureUITests..."
          xcodebuild test \
            -workspace manual_Trigger.xcworkspace \
            -scheme manual_Trigger \
            -only-testing:ArrayFeatureUITests \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
        continue-on-error: true

      - name: Check test results
        run: |
          if [ "${{ steps.first-leg.outcome }}" == "failure" ] || \
             [ "${{ steps.second-leg.outcome }}" == "failure" ] || \
             [ "${{ steps.third-leg.outcome }}" == "failure" ] || \
             [ "${{ steps.math-ui-tests.outcome }}" == "failure" ] || \
             [ "${{ steps.string-ui-tests.outcome }}" == "failure" ] || \
             [ "${{ steps.array-ui-tests.outcome }}" == "failure" ]; then
            echo "One or more test legs failed"
            exit 1
          else
            echo "All test legs passed"
          fi
