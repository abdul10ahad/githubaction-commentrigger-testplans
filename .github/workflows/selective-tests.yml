name: Selective Tests with Tuist (Modular)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  checks: write
  contents: read
  statuses: write

jobs:
  selective-tests:
    runs-on: macos-latest
    timeout-minutes: 20

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Tuist
        run: |
          brew install tuist

      - name: Install Mint
        run: |
          brew install mint

      - name: Install XcodeSelectiveTesting
        run: |
          mint install mikeger/XcodeSelectiveTesting@0.13.1

      - name: Generate Xcode project with Tuist
        run: |
          tuist generate

      - name: Analyze Changed Files and Dependencies
        id: analyze-changes
        run: |
          echo "=========================================="
          echo "üìä Selective Testing Analysis"
          echo "=========================================="
          echo ""

          echo "üîç Changed Files:"
          git diff --name-only origin/main | while read file; do
            echo "  ‚Ä¢ $file"
          done
          echo ""

          echo "üîó Running dependency analysis..."
          echo ""

          # Run XcodeSelectiveTesting with verbose and dry-run to show what will be tested
          mint run mikeger/XcodeSelectiveTesting@0.13.1 manual_Trigger.xcworkspace \
            --test-plan manual_Trigger/FirstLegTests.xctestplan \
            --base-branch origin/main \
            --verbose \
            --dry-run 2>&1 | tee /tmp/xst_analysis.log

          echo ""
          echo "=========================================="
          echo "üéØ Tests to Execute:"
          echo "=========================================="

          # Extract and display targets to test
          if grep -q "Targets to test:" /tmp/xst_analysis.log; then
            grep "Targets to test:" /tmp/xst_analysis.log -A 20 | grep "manual_Trigger:" | while read target; do
              case "$target" in
                *"MathFeatureUITests"*)
                  echo "  ‚úì MathFeatureUITests (FirstLegTests)"
                  ;;
                *"StringFeatureUITests"*)
                  echo "  ‚úì StringFeatureUITests (SecondLegTests)"
                  ;;
                *"ArrayFeatureUITests"*)
                  echo "  ‚úì ArrayFeatureUITests (ThirdLegTests)"
                  ;;
                *"manual_TriggerTests"*)
                  echo "  ‚úì manual_TriggerTests (AllUnitTests)"
                  ;;
              esac
            done
          else
            echo "  ‚ö†Ô∏è  No targets to test information found"
          fi

          echo ""
          echo "=========================================="

      - name: Run Selective Tests
        id: selective-tests
        run: |
          echo "Running selective tests with XcodeSelectiveTesting..."
          mint run mikeger/XcodeSelectiveTesting@0.13.1 manual_Trigger.xcworkspace \
            --test-plan manual_Trigger/AllUnitTests.xctestplan \
            --test-plan manual_Trigger/FirstLegTests.xctestplan \
            --test-plan manual_Trigger/SecondLegTests.xctestplan \
            --test-plan manual_Trigger/ThirdLegTests.xctestplan \
            --base-branch origin/main
        continue-on-error: true

      - name: Run Tests
        id: run-tests
        run: |
          echo "Executing all modified test plans..."
          xcodebuild test \
            -workspace manual_Trigger.xcworkspace \
            -scheme manual_Trigger \
            -destination 'platform=macOS' \
            -resultBundlePath TestResults.xcresult \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            | tee xcodebuild.log
        continue-on-error: true

      - name: Parse Test Results
        if: always()
        run: |
          echo "=========================================="
          echo "Test Execution Summary"
          echo "=========================================="
          echo ""

          # Extract test summary from xcodebuild output
          if [ -f xcodebuild.log ]; then
            echo "üìä Tests Executed:"
            echo ""

            # Count executed tests
            grep "Test Case.*passed\|Test Case.*failed" xcodebuild.log | while read -r line; do
              echo "  $line"
            done || echo "  (No test execution details found in logs)"

            echo ""
            echo "üìà Test Plan Summary:"

            # Look for test plan execution
            grep -A 2 "Testing with xcodebuild" xcodebuild.log || echo "  (Test plan details not found)"

            echo ""
            echo "üéØ UI Tests:"

            # Check for UI test execution
            if grep -q "MathFeatureUITests" xcodebuild.log; then
              echo "  ‚úì MathFeatureUITests - EXECUTED"
            else
              echo "  ‚úó MathFeatureUITests - NOT FOUND IN LOGS"
            fi

            if grep -q "StringFeatureUITests" xcodebuild.log; then
              echo "  ‚úì StringFeatureUITests - EXECUTED"
            else
              echo "  ‚úó StringFeatureUITests - NOT FOUND IN LOGS"
            fi

            if grep -q "ArrayFeatureUITests" xcodebuild.log; then
              echo "  ‚úì ArrayFeatureUITests - EXECUTED"
            else
              echo "  ‚úó ArrayFeatureUITests - NOT FOUND IN LOGS"
            fi

            echo ""
            echo "üìã Unit Tests:"

            if grep -q "manual_TriggerTests" xcodebuild.log; then
              echo "  ‚úì manual_TriggerTests - EXECUTED"

              # Count individual unit tests
              unit_test_count=$(grep -c "Test Case '-\[manual_TriggerTests" xcodebuild.log 2>/dev/null || echo "0")
              echo "    ‚Üí $unit_test_count unit test cases logged"
            else
              echo "  ‚úó manual_TriggerTests - NOT FOUND IN LOGS"
            fi
          else
            echo "‚ö†Ô∏è  xcodebuild.log not found"
          fi

          echo ""
          echo "=========================================="

      - name: Check test results
        if: always()
        run: |
          echo "=========================================="
          echo "Final Results"
          echo "=========================================="
          echo ""
          echo "XcodeSelectiveTesting: ${{ steps.selective-tests.outcome }}"
          echo "Test Execution: ${{ steps.run-tests.outcome }}"
          echo ""
          echo "=========================================="

          if [ "${{ steps.run-tests.outcome }}" == "failure" ]; then
            echo ""
            echo "‚ùå Tests failed!"
            echo ""
            echo "üí° Check the logs above for detailed error messages"
            echo "üí° XcodeSelectiveTesting modified test plans to run only affected tests"
            echo ""
            exit 1
          else
            echo ""
            echo "‚úÖ All affected tests passed!"
            echo "üí° XcodeSelectiveTesting ran only tests affected by your changes"
            echo ""
          fi
