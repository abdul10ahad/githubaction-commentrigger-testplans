name: Selective Tests with Tuist (Modular)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  checks: write
  contents: read
  statuses: write

jobs:
  selective-tests:
    runs-on: macos-latest
    timeout-minutes: 20

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Tuist
        run: |
          brew install tuist

      - name: Generate Xcode project with Tuist
        run: |
          tuist generate

      - name: Run All Unit Tests
        id: all-unit-tests
        run: |
          echo "Running All Unit Tests..."
          xcodebuild test \
            -workspace manual_Trigger.xcworkspace \
            -scheme manual_Trigger \
            -testPlan AllUnitTests \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
        continue-on-error: true

      - name: Run FirstLeg (Math Unit + UI Tests)
        id: first-leg
        run: |
          echo "Running FirstLegTests (Math Unit + UI Tests)..."
          xcodebuild test \
            -workspace manual_Trigger.xcworkspace \
            -scheme manual_Trigger \
            -testPlan FirstLegTests \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
        continue-on-error: true

      - name: Run SecondLeg (String Unit + UI Tests)
        id: second-leg
        run: |
          echo "Running SecondLegTests (String Unit + UI Tests)..."
          xcodebuild test \
            -workspace manual_Trigger.xcworkspace \
            -scheme manual_Trigger \
            -testPlan SecondLegTests \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
        continue-on-error: true

      - name: Run ThirdLeg (Array Unit + UI Tests)
        id: third-leg
        run: |
          echo "Running ThirdLegTests (Array Unit + UI Tests)..."
          xcodebuild test \
            -workspace manual_Trigger.xcworkspace \
            -scheme manual_Trigger \
            -testPlan ThirdLegTests \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
        continue-on-error: true

      - name: Check test results
        run: |
          echo "=========================================="
          echo "Test Results Summary"
          echo "=========================================="
          echo ""
          echo "Unit Tests:"
          echo "  AllUnitTests:     ${{ steps.all-unit-tests.outcome }} (${{ steps.all-unit-tests.conclusion }})"
          echo ""
          echo "Feature Tests (Unit + UI):"
          echo "  FirstLeg (Math):   ${{ steps.first-leg.outcome }} (${{ steps.first-leg.conclusion }})"
          echo "  SecondLeg (String): ${{ steps.second-leg.outcome }} (${{ steps.second-leg.conclusion }})"
          echo "  ThirdLeg (Array):  ${{ steps.third-leg.outcome }} (${{ steps.third-leg.conclusion }})"
          echo ""
          echo "=========================================="

          FAILED_TESTS=""
          FAILED_COUNT=0

          if [ "${{ steps.all-unit-tests.outcome }}" == "failure" ]; then
            FAILED_TESTS="${FAILED_TESTS}\n  ‚ùå AllUnitTests - ${{ steps.all-unit-tests.conclusion }}"
            FAILED_COUNT=$((FAILED_COUNT + 1))
          fi

          if [ "${{ steps.first-leg.outcome }}" == "failure" ]; then
            FAILED_TESTS="${FAILED_TESTS}\n  ‚ùå FirstLeg (Math Unit + UI) - ${{ steps.first-leg.conclusion }}"
            FAILED_COUNT=$((FAILED_COUNT + 1))
          fi

          if [ "${{ steps.second-leg.outcome }}" == "failure" ]; then
            FAILED_TESTS="${FAILED_TESTS}\n  ‚ùå SecondLeg (String Unit + UI) - ${{ steps.second-leg.conclusion }}"
            FAILED_COUNT=$((FAILED_COUNT + 1))
          fi

          if [ "${{ steps.third-leg.outcome }}" == "failure" ]; then
            FAILED_TESTS="${FAILED_TESTS}\n  ‚ùå ThirdLeg (Array Unit + UI) - ${{ steps.third-leg.conclusion }}"
            FAILED_COUNT=$((FAILED_COUNT + 1))
          fi

          if [ -n "$FAILED_TESTS" ]; then
            echo ""
            echo "‚ùå ${FAILED_COUNT} TEST PLAN(S) FAILED:"
            echo -e "$FAILED_TESTS"
            echo ""
            echo "üí° Check the logs above for detailed error messages"
            echo ""
            exit 1
          else
            echo ""
            echo "‚úÖ All 4 test plans passed!"
            echo ""
          fi
